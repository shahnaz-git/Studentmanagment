pipeline{
    agent any
    parameters{
        string(name: 'DOCKER_REPO', defaultValue: 'nxg-digital')
        string(name: 'DOCKER_IMAGE', defaultValue: 'studentmanagement')
        string(name: 'DOCKER_TAG', defaultValue: 'v1')
        string(name: 'database_name', defaultValue: '')
        string(name: 'namespace', defaultValue: 'default')
         
    }
    environment {
     BRANCH_NAME = "${GIT_BRANCH.split("/")[1]}"
  }
    stages{
        stage('SCM checkout'){
            steps{
                echo "Pulling...code"
                echo 'branchname...' + env.GIT_BRANCH
                echo "Pulling brnach code....${env.BRANCH_NAME}"
                git 'https://github.com/shahnaz-git/Studentmanagment.git'

               // git branch: "${env.BRANCH_NAME}" , credentialsId: 'github', url: 'https://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@github.com/nxgsolutions/nxgecomm-gke-deployment.git'
            }
        }
        stage('Deploy to k8s'){
            steps{
                 
                sh "gcloud container clusters get-credentials autopilot-cluster-1 --region asia-south1 --project nxgsols"
                sh "kubectl get pods"
            
                 
                
                script{
                        try{
                            sh "kubectl apply -f mysql-config.yaml"
                            sh "kubectl apply -f mysql-secret.yaml"
                            sh "kubectl apply -f student-deploy.yaml"
                            sh "kubectl apply -f student-service.yaml"
                            sh "kubectl apply -f student-service.yaml"
                            
                            sh "kubectl get pods"
                        } catch(error){
                            sh "kubectl create -f mysql-config.yaml"
                            sh "kubectl create -f mysql-secret.yaml"
                            sh "kubectl create -f student-deploy.yaml"
                            sh "kubectl create -f student-service.yaml"
                            sh "kubectl create -f student-service.yaml"
                            sh "kubectl get pods"
                        }
                }
            }
        }
    }
    post{
    success{
                emailext attachLog: true, body: "${currentBuild.currentResult}: Job ${env.JOB_NAME} build ${env.BUILD_NUMBER}\n More info at: ${env.BUILD_URL}", subject: 'Status : $PROJECT_NAME - Build # $BUILD_NUMBER - $BUILD_STATUS!', to: 'sowjanya@nxgsolutions.in'
                 }
    failure{
                echo "failed job!!!"
                emailext attachLog: true, body: "${currentBuild.currentResult}: Job ${env.JOB_NAME} build ${env.BUILD_NUMBER}\n More info at: ${env.BUILD_URL}", subject: 'Status : $PROJECT_NAME - Build # $BUILD_NUMBER - $BUILD_STATUS!', to: 'sowjanya@nxgsolutions.in'
              
                }
        }
}